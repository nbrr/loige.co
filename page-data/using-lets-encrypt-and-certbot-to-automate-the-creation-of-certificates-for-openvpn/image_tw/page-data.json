{"componentChunkName":"component---src-templates-blog-post-share-image-js","path":"/using-lets-encrypt-and-certbot-to-automate-the-creation-of-certificates-for-openvpn/image_tw","result":{"data":{"site":{"siteMetadata":{"title":"Luciano Mammino \"Loige\" - Cloud developer, entrepreneur, fighter, butterfly maker!","author":"Luciano Mammino","siteUrl":"https://loige.co","twitterProfile":"loige","disqusShortName":"loige"}},"markdownRemark":{"id":"ad3097e6-4e3c-5625-94e6-0e52f494db97","timeToRead":17,"headings":[{"value":"Installing Certbot","depth":2},{"value":"Generating a certificate with Certbot","depth":2},{"value":"A complete example infrastructure with Terraform","depth":2},{"value":"VPC & Subnet","depth":3},{"value":"The key pair","depth":3},{"value":"Security group","depth":3},{"value":"Subdomain","depth":3},{"value":"EC2 instance","depth":3},{"value":"Trigger-based provisioning with null_resource","depth":3},{"value":"The provider configuration and the variable file","depth":3},{"value":"Plan, apply and destroy","depth":3},{"value":"Some extra tips","depth":2},{"value":"Let’s Encrypt throttling","depth":3},{"value":"Certificate expiry and renewal","depth":3},{"value":"Intermittent failures during the provisioning","depth":3},{"value":"Wrapping up","depth":2}],"html":"<p>Recently at <a href=\"https://planet9energy.com\">Planet 9 Energy</a>, I had to setup a VPN access to secure some of our internal services. One of the requirements was to make the provisioning easy to reproduce over multiple environments, so we ended up playing a bit with Terraform, while obviously adopting OpenVPN for the VPN server.</p>\n<p>Another important requirement was to expose the OpenVPN web interface (also called Access Server) using an SSL, which I was expecting to be one of the most challenging things to automate, instead, it turned out to be very easy using <a href=\"https://letsencrypt.org\">Let’s Encrypt</a> and <a href=\"https://certbot.eff.org\">Certbot</a>.</p>\n<p>In this article, I will illustrate you how to use Certbot to automate the creation of SSL certificates (for OpenVPN as a practical example) and how to integrate this process in AWS-land using Terraform.</p>\n<h2 id=\"installing-certbot\" style=\"position:relative;\"><a href=\"#installing-certbot\" aria-label=\"installing certbot permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Installing Certbot</h2>\n<p>Installing Certbot on a Ubuntu (Xenial) machine is as easy as:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> -y <span class=\"token function\">install</span> software-properties-common\n<span class=\"token function\">sudo</span> add-apt-repository -y ppa:certbot/certbot\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> -y update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> -y <span class=\"token function\">install</span> certbot</code></pre></div>\n<p>This code uses the <code>certbot</code> PPA to install the executable.</p>\n<p>A Little tip (in case you don’t know it yet): <code>-y</code> allows the install to be non-interactive and to proceed without the need to confirm every operation from the keyboard.</p>\n<p>From this moment on you can use the <code>certbot</code> executable.</p>\n<p>If you want to have an idea of its capabilities you can simply run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">certbot --help</code></pre></div>\n<p>The outcome will be something like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 575px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 132.8125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAIAAADzvTiPAAAACXBIWXMAAAsSAAALEgHS3X78AAADvklEQVQ4y32UCXeqSBCFFUURV1DZEZEdIYqap+Zkck7ezP//TfOx5GW2MxXSQkN337p1b/UcxwnDaEd4O3fnGoZhWdZytTRNs/ev6Dfx/TydzviaNUEQZFnmuq5lM2ErirLzvIN/4GZPeN5oJP5zM1VVdV1fLBaGYWpbTVmt1uv1YrHcbremaRm6MZvNLNvWNV0aj+fzOd+PRqNu8el0zrPsx/3+eDxemnh//+35fJZleblciqK4Xq/H45HHIAz5+HK9+ge/w65p+nQ2dZw6W9txSDVJkmOeG4ZuWib4NU0TiH5fENrf/mAw6DJ33J1lmZ7nue5OXW/I2WADw/T2vmUa/YYkvh4Oh4ySNOb65mw8HreYOYFsP3//4/TyAsj7457nJJTmxyI/Hmv8t9ulqqgOGwGhW5/l+eFw6Pf6Q1E8nU5BE6yMkzSKoqq6kAjlPJ3PdUG9HR+TY71SFEXbdqIwhHAwed7+4PvebmfbdcXg3Nt7a1VdKiugUQVN11erVXfycrmiijBJtixgMZfThO/7WZZTZ2EgzOeLqTwlhL+KZLPZPt/ePj4+wAaq2+1GtrfXH9SJ+ff3d4SHENAfF/qh1NKEkCGrJ01kvuNwNmKOxKIoBAjJpVmaJCmvwiiM4hgWgJZmWXW5wORysegJgwE51Nv0eoIwaDlnbBRmQoQojigUB9ag5SkH8DuZSDVsSZpQ4c1mg/qoAXqK60OOSI1RN/StprmOy17rtdq6ozVIzRlswxDEthoCJLLy/b2qKIAELVuzUdQEdQEOuAzT0rabXhBE8AxVhyBwXac1XSsD4cuAv0YsITXRvuzJslwWZZZnlH4xnzeERUEQnquqFnlxxKcYPY4TZAftnEwVO2OxQXW57nZuK5jH45mmaRzXekJtesMcB0AKaBH43/zMFEyiLUVR+aM31KTKcj05Gvf+P0zL/vz8iYGRq6oqj+fb+VwVRfm4319fX+MkTpOUvA4HX57Iq9WyK1LXlgSB6iMLoS8A+/RyQiG4PwyDJE1bnquqwl5l+YL+SOobvKqujTrM5XJJx4HJVgbiUEQ53EiNiUd1jPnnLcb+0nZT/bqN2A5k/mdqg6+gOm0/6V6wmSxPKACqZIuJJMVJUjRBzmVR4C1SQEWIQVFWnNGZudEz6h4wApKRvagNVmv4U2mgpAPUrnsNB0Nx+N2GMCoyQNJVdUYnl0vdK2EFnmqfBweUBwoemcTsjKDrFs9m8/v9XtClyvJ8PqOqoizaxZv1Zjad0QwoO/biBldhwV/d4E+4ZIpFx5dpGQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/ecf9876f6711e42e12ccca556603cdd5/8d3d1/certbot-help-output-ubuntu.webp 256w,\n/static/ecf9876f6711e42e12ccca556603cdd5/354cf/certbot-help-output-ubuntu.webp 512w,\n/static/ecf9876f6711e42e12ccca556603cdd5/4410d/certbot-help-output-ubuntu.webp 575w\"\n          sizes=\"(max-width: 575px) 100vw, 575px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/ecf9876f6711e42e12ccca556603cdd5/85b06/certbot-help-output-ubuntu.png 256w,\n/static/ecf9876f6711e42e12ccca556603cdd5/bc282/certbot-help-output-ubuntu.png 512w,\n/static/ecf9876f6711e42e12ccca556603cdd5/facd4/certbot-help-output-ubuntu.png 575w\"\n          sizes=\"(max-width: 575px) 100vw, 575px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/ecf9876f6711e42e12ccca556603cdd5/facd4/certbot-help-output-ubuntu.png\"\n          alt=\"Certbot help output\"\n          title=\"Certbot help output\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n    </span></p>\n<h2 id=\"generating-a-certificate-with-certbot\" style=\"position:relative;\"><a href=\"#generating-a-certificate-with-certbot\" aria-label=\"generating a certificate with certbot permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Generating a certificate with Certbot</h2>\n<p>Certbot uses Let’s Encrypt to generate a certificate. Let’s encrypt issues a certificate for your domain only if able to verify that you really own that domain and that it is associated with the public IP of the machine from which you are running certbot.</p>\n<p>So, in order to pass the verification process, you need to have a web server running on your machine and accessible from the outside world. While Certbot supports the main web servers such as <a href=\"/tag/nginx/\">Nginx</a> and Apache, it also features a standalone server that you can use exclusively for the verification process. This web server will run on the standard web ports (80 and 443), so if you have other services using these ports you need to stop them first.</p>\n<p>In the case of OpenVPN you can stop its web server with:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">service</span> openvpnas stop</code></pre></div>\n<p>Then you can run certbot command line with the following options:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> certbot certonly <span class=\"token punctuation\">\\</span>\n  --standalone <span class=\"token punctuation\">\\</span>\n  --non-interactive <span class=\"token punctuation\">\\</span>\n  --agree-tos <span class=\"token punctuation\">\\</span>\n  --email YOUR_CERTIFICATE_EMAIL <span class=\"token punctuation\">\\</span>\n  --domains YOUR_DOMAIN <span class=\"token punctuation\">\\</span>\n  --pre-hook <span class=\"token string\">'sudo service openvpnas stop'</span> <span class=\"token punctuation\">\\</span>\n  --post-hook <span class=\"token string\">'sudo service openvpnas start'</span></code></pre></div>\n<p>Let’s see briefly what every option is doing:</p>\n<ul>\n<li><code>--standalone</code>: runs the standalone web server for the verification process.</li>\n<li><code>--non-interactive</code>: runs in totally automated mode, never asks for input.</li>\n<li><code>--agree-tos</code>: needed to make the above work, with this parameter you are confirming you agree to the terms of service.</li>\n<li><code>--email</code>: the certificate email.</li>\n<li><code>--domains</code>: the certificate domain.</li>\n<li><code>--pre-hook</code>: this is needed for the auto-renewal of the certificate and describes what is the command to run before the renewal process can be executed. We are using it to stop the OpenVPN web interface.</li>\n<li><code>--post-hook</code>: similar to the previous one, allows us to specify a command to be executed after a certificate is renewed, we use it to restart the OpenVPN web interface.</li>\n</ul>\n<p>This command generates numerous files including <code>server.crt</code> and <code>server.key</code>, the two files we need to use in OpenVPN. So let’s link them into the proper OpenVPN folder:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">ln</span> -s -f /etc/letsencrypt/live/YOUR_DOMAIN/cert.pem /usr/local/openvpn_as/etc/web-ssl/server.crt\n<span class=\"token function\">sudo</span> <span class=\"token function\">ln</span> -s -f /etc/letsencrypt/live/YOUR_DOMAIN/privkey.pem /usr/local/openvpn_as/etc/web-ssl/server.key</code></pre></div>\n<p>We link them because they will be changed in the future by the renewal process, so we are sure that OpenVPN will be always using the most updated certificate files.</p>\n<p>And, finally, we can restart OpenVPN:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">service</span> openvpnas start</code></pre></div>\n<p>After few seconds your OpenVPN website should be up and running, and with a shiny green icon indicating that the website is properly encrypted through a signed certificate, woohoo, well done!</p>\n<h2 id=\"a-complete-example-infrastructure-with-terraform\" style=\"position:relative;\"><a href=\"#a-complete-example-infrastructure-with-terraform\" aria-label=\"a complete example infrastructure with terraform permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A complete example infrastructure with Terraform</h2>\n<p>I am happy to share with you a simplified version of my Terraform OpenVPN project, to give you an example of how you can use the aforementioned details in a Terraform context.</p>\n<p>All the code available in the following section is also available as a <a href=\"https://github.com/lmammino/terraform-openvpn\">repository on GitHub</a>.</p>\n<p>Let’s start with a list of the AWS resources we need in order to provision a fully functional OpenVPN:</p>\n<ul>\n<li>A <strong>VPC</strong> (Virtual Private Cloud)</li>\n<li>One or more <strong>subnets</strong> in the VPC</li>\n<li>A <strong>EC2 instance</strong> to host OpenVPN</li>\n<li>A <strong>key pair</strong> to be able to SSH into the OpenVPN machine (for maintenance or troubleshooting)</li>\n<li>A <strong>security group</strong> (to enable traffic inside and outside the EC2 instance)</li>\n<li>A <strong>DNS record</strong> in Route53 to expose our VPN in a subdomain</li>\n</ul>\n<p>Quite a few things to be honest, but the declarative nature of Terraform will make things easy.</p>\n<p>Let’s create a file called <code>openvpn.tf</code> and let’s start to add things there:</p>\n<h3 id=\"vpc--subnet\" style=\"position:relative;\"><a href=\"#vpc--subnet\" aria-label=\"vpc  subnet permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>VPC &#x26; Subnet</h3>\n<p>Let’s create the VPC and the subnet:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"vpc_cidr_block\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"10.0.0.0/16\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"subnet_cidr_block\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"10.0.0.0/16\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_vpc\"</span></span> <span class=\"token string\">\"main\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">cidr_block</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">vpc_cidr_block</span><span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_subnet\"</span></span> <span class=\"token string\">\"vpn_subnet\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">vpc_id</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_vpc<span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">cidr_block</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">subnet_cidr_block</span><span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here we are using two variables <code>vpc_cidr_block</code> and <code>subnet_cidr_block</code> that can be easily reassigned from the outside to change the configuration if needed. By default, we are creating a VPC on the <code>10.0.0.0/16</code> IP range and a subnet spawning over the full VPN (same IP range).</p>\n<p>The rest of the code describing the VPC and the Subnet resources should be pretty self-explanatory.</p>\n<h3 id=\"the-key-pair\" style=\"position:relative;\"><a href=\"#the-key-pair\" aria-label=\"the key pair permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The key pair</h3>\n<p>Let’s create now the SSH key that we can use later in case we want to SSH into the OpenVPN machine.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"public_key\" </span></span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_key_pair\"</span></span> <span class=\"token string\">\"openvpn\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">key_name</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"openvpn-key\"</span>\n  <span class=\"token property\">public_key</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">public_key</span><span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Basically we are only defining here a <code>aws_key_pair</code> resource and specifying a name and the public key.</p>\n<p>Public key is a string that comes from the variable <code>public_key</code>.</p>\n<p>Most of the time you will be creating a dedicated key with the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ssh-keygen -f openvpn.key</code></pre></div>\n<p>this will create <code>openvpn.key</code> (private key) and <code>openvpn.key.pub</code> (public key). The first one is the one we would reference here.</p>\n<p>If we want to reference the content of a file we can use <code>\"${file(\"openvpn.key.pub\")}\"</code> to assign a terraform variable.</p>\n<h3 id=\"security-group\" style=\"position:relative;\"><a href=\"#security-group\" aria-label=\"security group permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Security group</h3>\n<p>Let’s create our security group:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"ssh_port\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">22</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"ssh_cidr\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"0.0.0.0/0\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"https_port\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">443</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"https_cidr\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"0.0.0.0/0\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"tcp_port\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">943</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"tcp_cidr\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"0.0.0.0/0\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"udp_port\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">1194</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"udp_cidr\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"0.0.0.0/0\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_security_group\"</span></span> <span class=\"token string\">\"openvpn\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"openvpn_sg\"</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Allow traffic needed by openvpn\"</span>\n  <span class=\"token property\">vpc_id</span>      <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_vpc<span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">}</span></span>\"</span>\n\n  <span class=\"token comment\">// ssh</span>\n  <span class=\"token keyword\">ingress</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">from_port</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">ssh_port</span><span class=\"token punctuation\">}</span></span>\"</span>\n    <span class=\"token property\">to_port</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">ssh_port</span><span class=\"token punctuation\">}</span></span>\"</span>\n    <span class=\"token property\">protocol</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"tcp\"</span>\n    <span class=\"token property\">cidr_blocks</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">ssh_cidr</span><span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// https</span>\n  <span class=\"token keyword\">ingress</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">from_port</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">https_port</span><span class=\"token punctuation\">}</span></span>\"</span>\n    <span class=\"token property\">to_port</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">https_port</span><span class=\"token punctuation\">}</span></span>\"</span>\n    <span class=\"token property\">protocol</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"tcp\"</span>\n    <span class=\"token property\">cidr_blocks</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">https_cidr</span><span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// open vpn tcp</span>\n  <span class=\"token keyword\">ingress</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">from_port</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">tcp_port</span><span class=\"token punctuation\">}</span></span>\"</span>\n    <span class=\"token property\">to_port</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">tcp_port</span><span class=\"token punctuation\">}</span></span>\"</span>\n    <span class=\"token property\">protocol</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"tcp\"</span>\n    <span class=\"token property\">cidr_blocks</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">tcp_cidr</span><span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// open vpn udp</span>\n  <span class=\"token keyword\">ingress</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">from_port</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">udp_port</span><span class=\"token punctuation\">}</span></span>\"</span>\n    <span class=\"token property\">to_port</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">udp_port</span><span class=\"token punctuation\">}</span></span>\"</span>\n    <span class=\"token property\">protocol</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"udp\"</span>\n    <span class=\"token property\">cidr_blocks</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">udp_cidr</span><span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// all outbound traffic</span>\n  <span class=\"token keyword\">egress</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">from_port</span>   <span class=\"token punctuation\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token property\">to_port</span>     <span class=\"token punctuation\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token property\">protocol</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"-1\"</span>\n    <span class=\"token property\">cidr_blocks</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>By default, this Security group allows access from every IP address using the ports 22 (SSH), 433 (HTTPS) and all outside traffic. It also enables the traffic needed for the OpenVPN protocol both on TCP (port 943) and UDP (port 1194).\nIn case you want a custom setup, you can redefine all the relevant variables here (but in that case you might need to customise also the OpenVPN settings, a step which is not covered in this article).</p>\n<h3 id=\"subdomain\" style=\"position:relative;\"><a href=\"#subdomain\" aria-label=\"subdomain permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Subdomain</h3>\n<p>Let’s now create the subdomain from where our VPN will be accessible.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"route53_zone_name\" </span></span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"subdomain_name\" </span></span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"subdomain_ttl\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"60\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">data <span class=\"token type variable\">\"aws_route53_zone\"</span></span> <span class=\"token string\">\"main\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">route53_zone_name</span><span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_route53_record\"</span></span> <span class=\"token string\">\"vpn\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">zone_id</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">aws_route53_zone</span><span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span>zone_id<span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">name</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">subdomain_name</span><span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">type</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"A\"</span>\n  <span class=\"token property\">ttl</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">subdomain_ttl</span><span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">records</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_instance<span class=\"token punctuation\">.</span>openvpn<span class=\"token punctuation\">.</span>public_ip<span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In this part of the code, we are defining 3 variables:</p>\n<ul>\n<li><code>route53_zone_name</code>: the name of your main domain zone (e.g. “example.com.”, notice the dot at the end).</li>\n<li><code>subdomain_name</code>: the name of the subdomain to use for the VPN (e.g. “vpn.example.com”).</li>\n<li><code>subdomain_ttl</code>: the TTL for the domain (60 seconds by default).</li>\n</ul>\n<p>Then, we create a reference to the Route53 zone using the <code>data</code> syntax.</p>\n<p>Finally, we create the record in the zone using an <code>aws_route53_record</code> resource.</p>\n<p>Notice that we are referencing here the EC2 instance public IP, which we haven’t defined yet.</p>\n<h3 id=\"ec2-instance\" style=\"position:relative;\"><a href=\"#ec2-instance\" aria-label=\"ec2 instance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>EC2 instance</h3>\n<p>Let’s see now how we can define the EC2 instance that will host the OpenVPN software for our virtual private cloud:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"ami\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ami-f53d7386\"</span> <span class=\"token comment\">// ubuntu xenial openvpn ami in eu-west-1</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"instance_type\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"t2.medium\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"admin_user\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"openvpn\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"admin_password\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"openvpn\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_instance\"</span></span> <span class=\"token string\">\"openvpn\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">tags</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">Name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"openvpn\"</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token property\">ami</span>                         <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">ami</span><span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">instance_type</span>               <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">instance_type</span><span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">key_name</span>                    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_key_pair<span class=\"token punctuation\">.</span>openvpn<span class=\"token punctuation\">.</span>key_name<span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">subnet_id</span>                   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_subnet<span class=\"token punctuation\">.</span>vpn_subnet<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">vpc_security_group_ids</span>      <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_security_group<span class=\"token punctuation\">.</span>openvpn<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token property\">associate_public_ip_address</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n\n  <span class=\"token comment\"># `admin_user` and `admin_pw` need to be passed in to the appliance through `user_data`, see docs --></span>\n  <span class=\"token comment\"># https://docs.openvpn.net/how-to-tutorialsguides/virtual-platforms/amazon-ec2-appliance-ami-quick-start-guide/</span>\n  <span class=\"token property\">user_data</span> <span class=\"token punctuation\">=</span> <span class=\"token heredoc string\">&lt;&lt;USERDATA\nadmin_user=${var.admin_user}\nadmin_pw=${var.admin_password}\nUSERDATA</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In this piece of code we are defining some variables:</p>\n<ul>\n<li><code>ami</code>: the id of the AMI (Amazon Machine Image) to use to run the EC2 instance. The default one is a Ubuntu Xenial OpenVPN machine that runs on the eu-west-1 region (Ireland). Feel free to <a href=\"https://cloud-images.ubuntu.com/locator/ec2/\">select another image</a> that might suit your needs best.</li>\n<li><code>instance_type</code>: the type of instance. You can check the <a href=\"https://aws.amazon.com/ec2/instance-types/\">list of all the type of EC2 instances</a> to understand which one might be the best for you. The default here is ok for most of the use cases.</li>\n<li><code>admin_user</code>, <code>admin_password</code>: The username and password of the admin user for your VPN.</li>\n</ul>\n<p>Whit all those variable in place, we can describe a <code>aws_instance</code> resource. Notice that we are defining it so that it will be bootstrapped in our VPC and in the subnet we specified before. Also notice that we are setting <code>associate_public_ip_address</code> to <code>true</code>, this way the machine will get a public IP (the one we will associate to the subdomain defined earlier).</p>\n<p>Finally we define a <code>user_data</code> property. <a href=\"http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html#instancedata-add-user-data\">EC2 User Data</a> allows to provide extra configuration code that is executed as soon as the machine is bootstrapped. It is generally used to install extra software, start some service or edit configuration values. In our case, since our image already contains OpenVPN, we use it only to provide the credentials for the default OpenVPN admin user.</p>\n<h3 id=\"trigger-based-provisioning-with-null_resource\" style=\"position:relative;\"><a href=\"#trigger-based-provisioning-with-null_resource\" aria-label=\"trigger based provisioning with null_resource permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Trigger-based provisioning with <code>null_resource</code></h3>\n<p>At this point we created all the resources we need and the OpenVPN admin can be already accessed by pointing the browser to your custom subdomain (using the HTTPS protocol).</p>\n<p>If you try to do that though, you will get a warning page saying that the certificate for this domain is not valid. This is because OpenVPN is using an auto-generated self-signed certificate which is not bound to your domain, neither signed by a trusted authority (such as Let’s Encrypt).</p>\n<p>So let’s do the interesting bit here, adding a Let’s Encrypt certificate for our subdomain!</p>\n<p>If you got the basics of Terraform and AWS here you might think that we can do this by simply adding few lines to our EC2 User Data script. While this, in theory, is not wrong, is not going to work in this case because of the way our resources here depend on each other. Let’s clarify exactly why…</p>\n<p>So in our current situation, we have to respect the following order of creating resources:</p>\n<ol>\n<li>Create a VPC</li>\n<li>Create a Subnet in the VPC</li>\n<li>Create a key pair and a security group</li>\n<li>Create an EC2 instance</li>\n<li>Create a subdomain record pointing to the public address of the EC2 instance</li>\n<li>(TODO) Create the certificate and install into the current OpenVPN instance</li>\n</ol>\n<p>So, the subdomain record can be created only after the EC2 instance is running and it has got a public IP address, only then we have a valid domain that we can use for the certificate. This means we cannot use the EC2 provisioning step, but we need to have a “trigger” that tells us when the subdomain is available and do some extra stuff.</p>\n<p>Terraform is smart enough to reconstruct the dependency graph of all our resources and to create the resources in the right order, so we don’t need to worry about that and we can keep loving the declarative style of its syntax.</p>\n<p>This means that the only thing left to do is to specify this trigger, which we can do by using a <a href=\"https://www.terraform.io/docs/provisioners/null_resource.html\"><code>null_resource</code></a>.</p>\n<p>Quoting the official documentation:</p>\n<blockquote>\n<p>The <code>null_resource</code> is a resource that allows you to configure provisioners that are not directly associated with a single existing resource.</p>\n</blockquote>\n<p>Let’s jump straight into the code, which I believe will make everything clear:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"certificate_email\" </span></span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"null_resource\"</span></span> <span class=\"token string\">\"provision_openvpn\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">triggers</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">subdomain_id</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_route53_record<span class=\"token punctuation\">.</span>vpn<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">connection</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ssh\"</span>\n    <span class=\"token property\">host</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_instance<span class=\"token punctuation\">.</span>openvpn<span class=\"token punctuation\">.</span>public_ip<span class=\"token punctuation\">}</span></span>\"</span>\n    <span class=\"token property\">user</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">ssh_user</span><span class=\"token punctuation\">}</span></span>\"</span>\n    <span class=\"token property\">private_key</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">private_key</span><span class=\"token punctuation\">}</span></span>\"</span>\n    <span class=\"token property\">agent</span>       <span class=\"token punctuation\">=</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">provisioner<span class=\"token type variable\"> \"remote-exec\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">inline</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"sudo apt-get install -y curl vim libltdl7 python3 python3-pip python software-properties-common unattended-upgrades\"</span>,\n      <span class=\"token string\">\"sudo add-apt-repository -y ppa:certbot/certbot\"</span>,\n      <span class=\"token string\">\"sudo apt-get -y update\"</span>,\n      <span class=\"token string\">\"sudo apt-get -y install python-certbot certbot\"</span>,\n      <span class=\"token string\">\"sudo service openvpnas stop\"</span>,\n      <span class=\"token string\">\"sudo certbot certonly --standalone --non-interactive --agree-tos --email <span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">certificate_email</span><span class=\"token punctuation\">}</span></span> --domains <span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">subdomain_name</span><span class=\"token punctuation\">}</span></span> --pre-hook 'service openvpnas stop' --post-hook 'service openvpnas start'\"</span>,\n      <span class=\"token string\">\"sudo ln -s -f /etc/letsencrypt/live/<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">subdomain_name</span><span class=\"token punctuation\">}</span></span>/cert.pem /usr/local/openvpn_as/etc/web-ssl/server.crt\"</span>,\n      <span class=\"token string\">\"sudo ln -s -f /etc/letsencrypt/live/<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">subdomain_name</span><span class=\"token punctuation\">}</span></span>/privkey.pem /usr/local/openvpn_as/etc/web-ssl/server.key\"</span>,\n      <span class=\"token string\">\"sudo service openvpnas start\"</span>,\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As you can see at the very top of this snippet of code, we are declaring a <code>null_resource</code> that is triggered when the value <code>aws_route53_record.vpn.id</code> changes, which happens when the subdomain is created. When this happens, Terraform will execute the provisioning logic defined in the rest of the code here, which essentially describes to Terraform how to connect to the OpenVPN machine and what code needs to be run and which we already discussed in the first part of this article.</p>\n<h3 id=\"the-provider-configuration-and-the-variable-file\" style=\"position:relative;\"><a href=\"#the-provider-configuration-and-the-variable-file\" aria-label=\"the provider configuration and the variable file permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The provider configuration and the variable file</h3>\n<p>Ok, our setup is almost ready… The only two things we have left to do are:</p>\n<ul>\n<li>define the needed configuration to connect to our AWS account;</li>\n<li>define some values for our configuration before we can run Terraform.</li>\n</ul>\n<p>To define the AWS config we need to specify the following terraform code (I generally do that into a dedicated file called <code>provider.tf</code>, but you can write this in any terraform file in your project):</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"aws_profile_name\" </span></span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"aws_region\" </span></span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">provider<span class=\"token type variable\"> \"aws\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">profile</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">aws_profile_name</span><span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">region</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">aws_region</span><span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Finally we can define the values for our variables. To do so we need to create a file called <code>terraform.tfvars</code> which contains a simple list of key-value pairs:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token property\">aws_profile_name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"default\"</span>\n<span class=\"token property\">aws_region</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"eu-west-1\"</span>\n<span class=\"token property\">public_key</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token function\">file</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"key.pub\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token property\">private_key</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token function\">file</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"key\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token property\">certificate_email</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"tech@example.com\"</span>\n<span class=\"token property\">route53_zone_name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"example.com.\"</span>\n<span class=\"token property\">subdomain_name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"vpn.example.com\"</span>\n\n<span class=\"token comment\"># vpc_cidr_block = \"10.0.0.0/16\"</span>\n<span class=\"token comment\"># subnet_cidr_block = \"10.0.0.0/16\"</span>\n<span class=\"token comment\"># ssh_port = 22</span>\n<span class=\"token comment\"># ssh_cidr = \"0.0.0.0/0\"</span>\n<span class=\"token comment\"># https_port = 443</span>\n<span class=\"token comment\"># https_cidr = \"0.0.0.0/0\"</span>\n<span class=\"token comment\"># tcp_port = 943</span>\n<span class=\"token comment\"># tcp_cidr = \"0.0.0.0/0\"</span>\n<span class=\"token comment\"># udp_port = 1194</span>\n<span class=\"token comment\"># udp_cidr = \"0.0.0.0/0\"</span>\n<span class=\"token comment\"># subdomain_ttl = 60</span>\n<span class=\"token comment\"># ami = \"ami-f53d7386\"</span>\n<span class=\"token comment\"># instance_type = \"t2.medium\"</span>\n<span class=\"token comment\"># admin_user = \"openvpn\"</span>\n<span class=\"token comment\"># admin_password = \"openvpn\"</span></code></pre></div>\n<p>The commented lines (starting with <code>#</code>) are left for your own reference, in case you want to change one of the configuration defaults.</p>\n<h3 id=\"plan-apply-and-destroy\" style=\"position:relative;\"><a href=\"#plan-apply-and-destroy\" aria-label=\"plan apply and destroy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Plan, apply and destroy</h3>\n<p>Ok, we are finally ready to run our Terraform project.</p>\n<p>In order to see what changes will be applied to your AWS account, your will need to run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">terraform plan</code></pre></div>\n<p>If you are happy with the displayed changes you can confirm them with:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">terraform apply</code></pre></div>\n<p>After few minutes you will have a fully provisioned Virtual Private Cloud with its own VPN access. Try to connect to the domain (<a href=\"https://vpn.example.com\">https://vpn.example.com</a>) and login in with your admin username and password!</p>\n<p>Ok, this was probably just a test project for you so you might fancy cleaning everything up… No problem, just run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">terraform destroy</code></pre></div>\n<p>and everything we just created will be blown away from your AWS account, leaving no trace behind!</p>\n<h2 id=\"some-extra-tips\" style=\"position:relative;\"><a href=\"#some-extra-tips\" aria-label=\"some extra tips permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Some extra tips</h2>\n<p>Just few extra tips before closing off…</p>\n<h3 id=\"lets-encrypt-throttling\" style=\"position:relative;\"><a href=\"#lets-encrypt-throttling\" aria-label=\"lets encrypt throttling permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Let’s Encrypt throttling</h3>\n<p>Let’s Encrypt allows you to generate a <strong>limited number of certificates for a given domain on a given timespan</strong>.</p>\n<p>Quoting directly from <a href=\"https://letsencrypt.org/docs/rate-limits/\">the Let’s Encrypt Rate Limit documentation</a>:</p>\n<blockquote>\n<p>The main limit is <strong>Certificates per Registered Domain (20 per week)</strong>. A registered domain is, generally speaking, the part of the domain you purchased from your domain name registrar. For instance, in the name www.example.com, the registered domain is example.com. In new.blog.example.co.uk, the registered domain is example.co.uk. We use the Public Suffix List to calculate the registered domain.</p>\n<p>If you have a lot of subdomains, you may want to combine them into a single certificate, up to a limit of 100 Names per Certificate. Combined with the above limit, that means you can issue certificates containing up to <strong>2,000 unique subdomains per week</strong>. A certificate with multiple names is often called a SAN certificate, or sometimes a UCC certificate.</p>\n<p>We also have a <strong>Duplicate Certificate limit of 5 certificates per week</strong>. A certificate is considered a duplicate of an earlier certificate if they contain the exact same set of hostnames, ignoring capitalization and ordering of hostnames. For instance, if you requested a certificate for the names [www.example.com, example.com], you could request four more certificates for [www.example.com, example.com] during the week. If you changed the set of names by adding [blog.example.com], you would be able to request additional certificates.</p>\n</blockquote>\n<p>So, be careful not to blow your production domain while playing with Terraform (or with certbot in general).</p>\n<p>There are options to generate <em>test</em> or <em>staging</em> certificates, although I haven’t experimented much with them, so I can only suggest you to have a look at the documentation illustration all the <a href=\"https://certbot.eff.org/docs/using.html#certbot-command-line-options\">available command line options</a>.</p>\n<p>Huge thanks to <a href=\"https://www.reddit.com/user/tialaramex\">tialaramex</a> on Reddit for <a href=\"https://www.reddit.com/r/linuxadmin/comments/6ia1wx/use_certbot_to_automate_the_creation_of_ssl/dj57zlw/\">a fruitful discussion</a> and few pieces of advice about this specific aspect.</p>\n<h3 id=\"certificate-expiry-and-renewal\" style=\"position:relative;\"><a href=\"#certificate-expiry-and-renewal\" aria-label=\"certificate expiry and renewal permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Certificate expiry and renewal</h3>\n<p>Let’s Encrypt <strong>certificates expire after 3 months</strong>, so be sure you enable the auto renewal feature.</p>\n<p>In reality, the feature is enabled by default, so what’s left to do is to test the auto renewal process. With certbot you can do that using the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">certbot renew --dry-run</code></pre></div>\n<p>There’s another important point here to take into account here: everytime the certificate renewal procedure is triggered, your VPN service gets shutdown for few seconds and all the currently connected users are disconnected.</p>\n<p>This will happen only once every 2-3 months, but if it’s a real struggle for your organisation you might want to explore different setups.</p>\n<p>One solution could be to setup a reverse proxy like Nginx and use it for the SSL termination. This way during the renewal you will only shutdown nginx and not the full VPN service.</p>\n<p>Thanks again to <a href=\"https://www.reddit.com/user/tialaramex\">tialaramex</a> on Reddit for raising this discussion and proposing the reverse proxy solution.</p>\n<h3 id=\"intermittent-failures-during-the-provisioning\" style=\"position:relative;\"><a href=\"#intermittent-failures-during-the-provisioning\" aria-label=\"intermittent failures during the provisioning permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Intermittent failures during the provisioning</h3>\n<p>I had some problems during the installation of certbot on the image used here by default. If this is happening to you as well, you should be able to sort them out by running an <code>apt-get upgrade</code> before trying to install certbot. Since you want to do that in an automated fashion, you’ll probably need a more sophisticated command that takes care of auto-responding to possible prompts: <code>yes | sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade</code>.</p>\n<h2 id=\"wrapping-up\" style=\"position:relative;\"><a href=\"#wrapping-up\" aria-label=\"wrapping up permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wrapping up</h2>\n<p>This is just a quick example focused on OpenVPN, but you can use the same approach to generate certificates for other web applications. Consult the <a href=\"https://certbot.eff.org/docs/\">Certbot documentation </a> to see all the supported web servers and how to use Certbot with them.</p>\n<p>Also, I hope this tutorial gave you a good idea on how to use Terraform to automate your infrastructure provisioning. I am still a bit of noob with it, so if you see I have done something terribly wrong (or something that can be improved), please let me know in the comments.</p>\n<p>Thanks to <a href=\"https://twitter.com/Podgeypoos79\">@Podgeypoos79</a>, <a href=\"https://twitter.com/tech_fort\">@techfort</a>, <em>Alan</em> and the rest of Planet 9 tech team for working with me on this cool 💩 (chocolate ice cream!). Also a huge thanks to my friend <a href=\"https://twitter.com/gianarb\">@gianarb</a> for some precious <em>devopsy</em> bits of advice.</p>\n<p>Let me know in the comments if this article was useful for you and if you integrated something similar in one of your projects!</p>\n<p>See you in the next post :)</p>","frontmatter":{"title":"Using Let’s Encrypt and Certbot to automate the creation of certificates for OpenVPN","slug":"using-lets-encrypt-and-certbot-to-automate-the-creation-of-certificates-for-openvpn","author":"Luciano Mammino","tags":["ssl","web","terraform","security","aws"],"date":"June 19, 2017","header_img":{"publicURL":"/static/45dfcbcf12ab7cac8a20f867207af385/using-lets-encrypt-and-certbot-to-automate-the-creation-of-certificates-for-openvpn-loige-icover-image.jpg"}}}},"pageContext":{"slug":"using-lets-encrypt-and-certbot-to-automate-the-creation-of-certificates-for-openvpn","width":440,"height":220,"type":"twitter"}},"staticQueryHashes":[]}