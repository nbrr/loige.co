{"componentChunkName":"component---src-templates-blog-post-share-image-js","path":"/symfony-edit-the-response-globally-using-the-kernel-response-event/image_fb","result":{"data":{"site":{"siteMetadata":{"title":"Luciano Mammino \"Loige\" - Cloud developer, entrepreneur, fighter, butterfly maker!","author":"Luciano Mammino","siteUrl":"https://loige.co","twitterProfile":"loige","disqusShortName":"loige"}},"markdownRemark":{"id":"19def87a-9989-5a8c-937f-00e60168ec8d","timeToRead":5,"headings":[{"value":"The Kernel Response event","depth":2},{"value":"Example 1. Add custom Http headers to notify remaining api calls","depth":3},{"value":"Example 2. Create a cookie to track referrals","depth":3},{"value":"Conclusion","depth":2}],"html":"<p>One of the things I like most of the Symfony framework is its <a href=\"https://packagist.org/packages/symfony/http-kernel\">Http Kernel component</a>. Not only it does offer a very straightforward abstraction to handle requests and responses in an object-oriented way but it also allows you to interact with the whole response generation process through <a href=\"http://symfony.com/doc/current/components/http_kernel/introduction.html#creating-an-event-listener\">events</a>.</p>\n<p><a href=\"http://symfony.com/doc/current/components/http_kernel/introduction.html\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 690px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.15625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABuklEQVQoz3VSTW/TQBD17+LML+J3IHFAKhcQAlXcOCBagagqxKGHiBY1ok0RDVVIaie146SJ93NmZ5ZZm0AA8bzyeL1vPnbeZH4DY7VxGhHCFkieFriB30LWGQCYNzfT27HxiolJnARiaRMkBOEYY1AMbDnLLmA6A/SSQ6zSShmljXLeQluL5Gz90TovX8nV+aw9ksDIFFiSxpRQthQSm2Jot9Sdaot5pYwDQvIOMo8WSSKydhhD5HVkx4EjUGSKUUW2UaBtCgVASw2ILC4eXLZ7/ODt4Nmbo+LxYX65V+zd6V/sXL/q5Tv7k/Pe7N3ds969b5P56uHLy6OzejjVj15PP09GL07u7w92s0H5cbQ8/z5z/bFZXZkvT4r6U3NV+dORW5Tu6/P8+mBhPL4/rcelLxbNYX9erZv+zYeL8iSLHNslt8XInEqM3fsP5NMZUfTBOFx1FGlC5kG6lwSUqyRVIRB2AicgEAeywE8PquPhQomgthG3emXqW5Wk+im/NJyZ/oH8krDDAuZrIUgO4Ydyaaql+T0k2mon7ReZhRD+XjFKSVKkMBxskP2aNW2Sc/gPUmEpDGyP5w9w6qv4jYi7gQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/7cc916d92fa24000093d9ecdcc4ad955/8d3d1/symfony-http-kernel-component-overview-scheme.webp 256w,\n/static/7cc916d92fa24000093d9ecdcc4ad955/354cf/symfony-http-kernel-component-overview-scheme.webp 512w,\n/static/7cc916d92fa24000093d9ecdcc4ad955/6bd32/symfony-http-kernel-component-overview-scheme.webp 690w\"\n          sizes=\"(max-width: 690px) 100vw, 690px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/7cc916d92fa24000093d9ecdcc4ad955/85b06/symfony-http-kernel-component-overview-scheme.png 256w,\n/static/7cc916d92fa24000093d9ecdcc4ad955/bc282/symfony-http-kernel-component-overview-scheme.png 512w,\n/static/7cc916d92fa24000093d9ecdcc4ad955/86e67/symfony-http-kernel-component-overview-scheme.png 690w\"\n          sizes=\"(max-width: 690px) 100vw, 690px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/7cc916d92fa24000093d9ecdcc4ad955/86e67/symfony-http-kernel-component-overview-scheme.png\"\n          alt=\"Symfony Http Kernel component overview\"\n          title=\"Symfony Http Kernel component overview\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n    </span></a></p>\n<p>This approach is very convenient and flexible and in fact the Http Kernel component is the foundation of the Symfony framework but also of several other famous frameworks (Silex, Laravel) and CMSes (Drupal, BackBee CMS).</p>\n<h2 id=\"the-kernel-response-event\" style=\"position:relative;\"><a href=\"#the-kernel-response-event\" aria-label=\"the kernel response event permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Kernel Response event</h2>\n<p>One event that I’ve been using a lot lately is the <a href=\"http://api.symfony.com/master/Symfony/Component/HttpKernel/Event/FilterResponseEvent.html\">Kernel Response event</a> which allows you to edit the response after it has been generated.</p>\n<p>Thanks to this event you can easily modify the response object (cookies, headers, content, etc.) before it gets sent out to the user without affecting the specific logic of every controller thus avoiding code cluttering and duplication.</p>\n<p>I will present two different real case scenarios to show how useful (and simple) it is.</p>\n<h3 id=\"example-1-add-custom-http-headers-to-notify-remaining-api-calls\" style=\"position:relative;\"><a href=\"#example-1-add-custom-http-headers-to-notify-remaining-api-calls\" aria-label=\"example 1 add custom http headers to notify remaining api calls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example 1. Add custom Http headers to notify remaining api calls</h3>\n<p>Let’s suppose we developed a wonderful rate limited api and now we want to add some custom headers to notify the user about how much he is using the API.\nIt seems a good idea to copy the approach adopted by the GitHub APIs and add three custome headers: <code>X-RateLimit-Limit</code> (maximum number of requests per period), <code>X-RateLimit-Remaining</code> (remaining requests in the current period) and <code>X-RateLimit-Reset</code> (the timestamp on which the current period ends).</p>\n<p>As I don’t want to implement a fully working solution here let’s assume we have already written a rate limit checker service registered as <code>rate_limit_checker</code> that implements the following interface:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">RateLimitCheckerInterface</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getRateLimit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getRateLimitRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getRateLimitReset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Let’s now write our <code>RateLimitHeadersListener</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">Symfony<span class=\"token punctuation\">\\</span>Component<span class=\"token punctuation\">\\</span>HttpKernel<span class=\"token punctuation\">\\</span>Event<span class=\"token punctuation\">\\</span>FilterResponseEvent</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RateLimitHeadersListener</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token variable\">$rateLimitChecker</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span>\n    \tRateLimitCheckerInterface <span class=\"token variable\">$rateLimitChecker</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    \t<span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">rateLimitChecker</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$rateLimitChecker</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">onKernelResponse</span><span class=\"token punctuation\">(</span>FilterResponseEvent <span class=\"token variable\">$event</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$headers</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$event</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getResponse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">headers</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$headers</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>\n        \t<span class=\"token single-quoted-string string\">'X-RateLimit-Limit'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">rateLimitChecker</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getRateLimit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$headers</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>\n        \t<span class=\"token single-quoted-string string\">'X-RateLimit-Remaining'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">rateLimitChecker</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getRateLimitRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$headers</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>\n        \t<span class=\"token single-quoted-string string\">'X-RateLimit-Reset'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">rateLimitChecker</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getRateLimitReset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we need to register the listener as a tagged service:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\">#services.yml</span>\n<span class=\"token key atrule\">rate_limit_listener</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">class</span><span class=\"token punctuation\">:</span> RateLimitHeadersListener\n  <span class=\"token key atrule\">arguments</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'@rate_limit_checker'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kernel.event_listener<span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span> kernel.response<span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> onKernelResponse<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span></code></pre></div>\n<p>That’s it. Really straightforward, isn’t it?\nShould be clear now that, by using this event based approach, we don’t have to touch the logic of every single controller.</p>\n<p>Take a small break and get ready to jump to another example.</p>\n<h3 id=\"example-2-create-a-cookie-to-track-referrals\" style=\"position:relative;\"><a href=\"#example-2-create-a-cookie-to-track-referrals\" aria-label=\"example 2 create a cookie to track referrals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example 2. Create a cookie to track referrals</h3>\n<p>Well, now imagine that we have to build an affiliate program based on referral links (<a href=\"https://sbaam.com/affiliates?_r=9oj\">I did it</a> lately).</p>\n<p>The general idea is that our affiliates are identified by an ID that they can attach to every url of the website as query parameter. This way every URL of our website can be an entry point for our visitors and our affiliates are free to promote the content that is more relevant for them.\nDoing so we need to verify every possibile request to check for the referrral parameter and keep track of the whole session of the visitor (or even better monitor him for a given amount of days) to see if his visits converts into some kind of action for which we have to reward the affiliate.\nTo write a more formal specification we have to:</p>\n<ol>\n<li>Allow any of our affiliates to share links with a special referral code as query parameter: <code>?_ref=&#x3C;REF_ID></code> (where <code>REF_ID</code> is the unique id of the affiliate).</li>\n<li>Intercept visitor referred by affiliates through the referral parameter and identify the referral</li>\n<li>Create a cookie to track the referred visitor for 30 days</li>\n</ol>\n<p>Again we can use the Kernel Response Event and create a dedicated listener for this task. Before doing so suppose we have already developed a mechanism to store our affiliates and that we have coded a <code>affiliate_repository</code> service which implementats of the following interface:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">AffiliateRepositoryInterface</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">findOneById</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now let’s write our listener to intercept clicks on referral links:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AffiliateLinkClickListener</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token variable\">$affiliateRepository</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span>\n    \tAffiliateRepositoryInterface <span class=\"token variable\">$affiliateRepository</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    \t<span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">affiliateRepository</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$affiliateRepository</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">onKernelResponse</span><span class=\"token punctuation\">(</span>FilterResponseEvent <span class=\"token variable\">$event</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n    \t<span class=\"token variable\">$request</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$event</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$response</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$event</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getResponse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 1.</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">query</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'_ref'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        \t<span class=\"token variable\">$affiliateId</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">query</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'_ref'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">// 2.</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">null</span> <span class=\"token operator\">!==</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">affiliateRepository</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">findOneById</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$affiliateId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            \t<span class=\"token comment\">// 3.</span>\n                <span class=\"token variable\">$cookie</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Cookie</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'_ref'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$affiliateId</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token punctuation\">\\</span>DateTime</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'+30 days'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token variable\">$response</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">headers</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">setCookie</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$cookie</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The code is pretty simple here:</p>\n<ol>\n<li>We check if there’s a <code>_ref</code> parameter in the current request</li>\n<li>If so we check if we have an affiliate with the id found in the <code>_ref</code> parameter</li>\n<li>If that’s the case we create a cookie that will allow us to keep track of the referral for 30 days.</li>\n</ol>\n<p>Obviously don’t forget to register the listener as a tagged service:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\">#services.yml</span>\n<span class=\"token key atrule\">affiliate_link_click_listener</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">class</span><span class=\"token punctuation\">:</span> AffiliateLinkClickListener\n  <span class=\"token key atrule\">arguments</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'@affiliate_repository'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kernel.event_listener<span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span> kernel.response<span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> onKernelResponse<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span></code></pre></div>\n<p>As I said, this mechanisms allows you to track the reference but you also need to track any conversion and check the cookie to see if it has been generated by some affiliate.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>As in every tutorial, bear in mind that the code is just a sample to give you a general idea about an approach you can follow to solve some generic problem. You need to adapt it to your use case and consider relevant factors such as security, testing, etc.</p>\n<p>Let me know what you think with a comment (<a href=\"#disqus_thread\">comments</a>) and feel free to suggest other real-life use cases for the Kernel Response Event.</p>\n<p>Thanks!</p>\n<p>PS: Huge thanks to <a href=\"http://twitter.com/AxelLessio\">@AxelLessio</a> and <a href=\"http://twitter.com/javiereguiluz\">@JavierEguiluz</a> for taking the time to review my very bad english ;)</p>","frontmatter":{"title":"Symfony, edit the Response globally using the Kernel Response event","slug":"symfony-edit-the-response-globally-using-the-kernel-response-event","author":"Luciano Mammino","tags":["php","symfony","http"],"date":"February 21, 2015","header_img":{"publicURL":"/static/6ac1c6c77e2d54cb09869c500106341d/symfony-edit-the-response-globally-using-the-kernel-response-event.jpg"}}}},"pageContext":{"slug":"symfony-edit-the-response-globally-using-the-kernel-response-event","width":1200,"height":630,"type":"facebook"}},"staticQueryHashes":[]}